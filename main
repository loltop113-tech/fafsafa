import asyncio
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command, StateFilter
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.storage.memory import MemoryStorage
from datetime import datetime
import random

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BOT_TOKEN = "8525067714:AAEDsOTfqxrmHhcM6by3x0sGkagDUwthHbQ"
ADMIN_CHAT_ID = 6918401002  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ë–î)
users_db = {}
orders_db = []
pending_payments = []  # –°–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π

# –°—Ç–µ–π—Ç—ã –¥–ª—è FSM
class OrderStates(StatesGroup):
    waiting_for_link = State()
    waiting_for_reviews_count = State()
    waiting_for_review_text = State()
    waiting_for_contacts = State()

class AdminStates(StatesGroup):
    waiting_for_user_id = State()
    waiting_for_amount = State()
    waiting_for_rejection_reason = State()
    waiting_for_screenshot = State()

class PaymentStates(StatesGroup):
    waiting_for_amount = State()
    waiting_for_screenshot = State()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_main_keyboard(user_id):
    keyboard = [
        [KeyboardButton(text="üìù –ó–∞–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã")],
        [KeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton(text="üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å")],
        [KeyboardButton(text="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"), KeyboardButton(text="üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞")]
    ]
    
    if user_id == ADMIN_CHAT_ID:
        keyboard.append([KeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")])
    
    return ReplyKeyboardMarkup(keyboard=keyboard, resize_keyboard=True)

def get_cancel_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]],
        resize_keyboard=True
    )

def get_skip_text_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å")],
            [KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")]
        ],
        resize_keyboard=True
    )

def get_admin_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é")],
            [KeyboardButton(text="‚è≥ –û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è")],
            [KeyboardButton(text="üìã –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã")],
            [KeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")],
            [KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥")]
        ],
        resize_keyboard=True
    )

def generate_payment_id():
    return random.randint(100000, 999999)

def generate_order_id():
    return random.randint(100000, 999999)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def init_user(user_id):
    if user_id not in users_db:
        users_db[user_id] = {
            'balance': 0,
            'username': '',
            'orders_count': 0
        }

# –ö–æ–º–∞–Ω–¥–∞ /start
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    init_user(user_id)
    
    await message.answer(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –∑–∞–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –≤ 2–ì–ò–°.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_keyboard(user_id)
    )

# –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.message(F.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def show_profile(message: types.Message):
    user_id = message.from_user.id
    init_user(user_id)
    
    user_data = users_db[user_id]
    await message.answer(
        f"üìä –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n"
        f"üíº –ë–∞–ª–∞–Ω—Å: {user_data['balance']} —Ä—É–±.\n"
        f"üì¶ –ó–∞–∫–∞–∑–æ–≤: {user_data['orders_count']}\n"
        f"üë§ ID: {user_id}"
    )

# –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ - –Ω–∞—á–∞–ª–æ
@dp.message(F.text == "üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å")
async def start_payment(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    init_user(user_id)
    
    await message.answer(
        "üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞\n\n"
        "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —Ä—É–±–ª—è—Ö):\n\n"
        "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 10 —Ä—É–±.\n"
        "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 10000 —Ä—É–±.",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(PaymentStates.waiting_for_amount)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
@dp.message(PaymentStates.waiting_for_amount)
async def process_payment_amount(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer(
            "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ",
            reply_markup=get_main_keyboard(user_id)
        )
        return
        
    if not message.text.isdigit():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ):", reply_markup=get_cancel_keyboard())
        return
        
    amount = int(message.text)
    
    if amount < 10:
        await message.answer("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è - 10 —Ä—É–±–ª–µ–π:", reply_markup=get_cancel_keyboard())
        return
        
    if amount > 10000:
        await message.answer("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è - 10000 —Ä—É–±–ª–µ–π:", reply_markup=get_cancel_keyboard())
        return
        
    await state.update_data(amount=amount)
    
    await message.answer(
        f"üí≥ –î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ {amount} —Ä—É–±.:\n\n"
        "1. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º:\n"
        "üíé –û–ó–û–ù-–ë–ê–ù–ö: 2204320908458443\n"
        "–ü–æ–ª—É—á–∞—Ç–µ–ª—å: –ú–∞—Ç–≤–µ–π\n\n"
        "2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞\n\n"
        "–ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã.",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(PaymentStates.waiting_for_screenshot)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
@dp.message(PaymentStates.waiting_for_screenshot)
async def process_screenshot(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer(
            "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ",
            reply_markup=get_main_keyboard(user_id)
        )
        return
    
    user_data = await state.get_data()
    amount = user_data['amount']
    
    # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ñ–æ—Ç–æ, –ø—Ä–æ—Å–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç
    if not message.photo:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ –æ–± –æ–ø–ª–∞—Ç–µ:", reply_markup=get_cancel_keyboard())
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
    payment_id = generate_payment_id()
    payment_request = {
        'id': payment_id,
        'user_id': user_id,
        'amount': amount,
        'screenshot_file_id': message.photo[-1].file_id,
        'username': message.from_user.username,
        'user_full_name': message.from_user.full_name,
        'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'status': 'pending'
    }
    pending_payments.append(payment_request)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞—è–≤–∫—É –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏
    payment_text = (
        "üí∞ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞!\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.full_name}\n"
        f"üìõ @{message.from_user.username or '–ù–µ—Ç username'}\n"
        f"üÜî ID: {user_id}\n"
        f"üí≥ –°—É–º–º–∞: {amount} —Ä—É–±.\n"
        f"‚è∞ –í—Ä–µ–º—è: {payment_request['timestamp']}"
    )
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"approve_payment_{payment_id}"),
            InlineKeyboardButton(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_payment_{payment_id}")
        ]
    ])
    
    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
    await bot.send_photo(ADMIN_CHAT_ID, message.photo[-1].file_id, 
                        caption=payment_text, reply_markup=keyboard)
    
    await message.answer(
        "‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\n\n"
        f"–°—É–º–º–∞: {amount} —Ä—É–±.\n"
        "–ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.",
        reply_markup=get_main_keyboard(user_id)
    )
    
    await state.clear()

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
@dp.message(F.text == "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
async def admin_panel(message: types.Message):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
        
    total_users = len(users_db)
    total_orders = len(orders_db)
    total_balance = sum(user['balance'] for user in users_db.values())
    pending_count = len([p for p in pending_payments if p['status'] == 'pending'])
    pending_orders_count = len([o for o in orders_db if o.get('status') == 'pending'])
    
    await message.answer(
        f"‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n"
        f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"üìä –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {total_orders}\n"
        f"‚è≥ –û–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤: {pending_orders_count}\n"
        f"üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: {total_balance} —Ä—É–±.\n"
        f"üí≥ –û–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π: {pending_count}",
        reply_markup=get_admin_keyboard()
    )

# –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
@dp.message(F.text == "üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é")
async def add_balance_start(message: types.Message, state: FSMContext):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
        
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(AdminStates.waiting_for_user_id)

# –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.message(AdminStates.waiting_for_user_id)
async def get_user_id(message: types.Message, state: FSMContext):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer(
            "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞",
            reply_markup=get_admin_keyboard()
        )
        return
        
    if not message.text.isdigit():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–∏—Å–ª–æ):", reply_markup=get_cancel_keyboard())
        return
        
    user_id = int(message.text)
    await state.update_data(user_id=user_id)
    
    await message.answer(
        "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(AdminStates.waiting_for_amount)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É–º–º—ã –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
@dp.message(AdminStates.waiting_for_amount)
async def get_amount(message: types.Message, state: FSMContext):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer(
            "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞",
            reply_markup=get_admin_keyboard()
        )
        return
        
    if not message.text.isdigit():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ):", reply_markup=get_cancel_keyboard())
        return
        
    amount = int(message.text)
    user_data = await state.get_data()
    user_id = user_data['user_id']
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    init_user(user_id)
    
    # –ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å
    users_db[user_id]['balance'] += amount
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await bot.send_message(
            user_id,
            f"‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} —Ä—É–±.\n"
            f"üíº –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {users_db[user_id]['balance']} —Ä—É–±."
        )
    except:
        pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
    
    await message.answer(
        f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} —Ä—É–±.\n"
        f"üíº –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {users_db[user_id]['balance']} —Ä—É–±.",
        reply_markup=get_admin_keyboard()
    )
    await state.clear()

# –û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
@dp.message(F.text == "‚è≥ –û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è")
async def show_pending_payments(message: types.Message):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
        
    pending_list = [p for p in pending_payments if p['status'] == 'pending']
    
    if not pending_list:
        await message.answer(
            "–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π.",
            reply_markup=get_admin_keyboard()
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Å –∫–Ω–æ–ø–∫–∞–º–∏
    for payment in pending_list:
        text = (
            f"‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {payment['user_full_name']}\n"
            f"üìõ @{payment['username'] or '–ù–µ—Ç username'}\n"
            f"üÜî ID: {payment['user_id']}\n"
            f"üí∞ –°—É–º–º–∞: {payment['amount']} —Ä—É–±.\n"
            f"‚è∞ –í—Ä–µ–º—è: {payment['timestamp']}"
        )
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"approve_payment_{payment['id']}"),
                InlineKeyboardButton(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_payment_{payment['id']}")
            ]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
        await bot.send_photo(
            message.chat.id,
            payment['screenshot_file_id'],
            caption=text,
            reply_markup=keyboard
        )
    
    await message.answer(
        f"–í—Å–µ–≥–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π: {len(pending_list)}",
        reply_markup=get_admin_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
@dp.callback_query(F.data.startswith("approve_payment_"))
async def approve_payment(callback: types.CallbackQuery):
    payment_id = int(callback.data.split("_")[2])
    
    # –ù–∞—Ö–æ–¥–∏–º –∑–∞—è–≤–∫—É
    payment = None
    for p in pending_payments:
        if p['id'] == payment_id and p['status'] == 'pending':
            payment = p
            break
    
    if not payment:
        await callback.answer("–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞", show_alert=True)
        return
    
    user_id = payment['user_id']
    amount = payment['amount']
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    init_user(user_id)
    
    # –ü–æ–ø–æ–ª–Ω—è–µ–º –±–∞–ª–∞–Ω—Å
    users_db[user_id]['balance'] += amount
    
    # –ü–æ–º–µ—á–∞–µ–º –∑–∞—è–≤–∫—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
    payment['status'] = 'approved'
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    new_text = (
        f"‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {payment['user_full_name']}\n"
        f"üìõ @{payment['username'] or '–ù–µ—Ç username'}\n"
        f"üÜî ID: {payment['user_id']}\n"
        f"üí∞ –°—É–º–º–∞: {payment['amount']} —Ä—É–±.\n"
        f"‚è∞ –í—Ä–µ–º—è: {payment['timestamp']}\n"
        f"üïê –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    )
    
    await callback.message.edit_caption(
        caption=new_text,
        reply_markup=None  # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await bot.send_message(
            user_id,
            f"‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} —Ä—É–±.\n"
            f"üíº –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {users_db[user_id]['balance']} —Ä—É–±."
        )
    except:
        pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
    
    await callback.answer(f"–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} —Ä—É–±.")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
@dp.callback_query(F.data.startswith("reject_payment_"))
async def reject_payment(callback: types.CallbackQuery):
    payment_id = int(callback.data.split("_")[2])
    
    # –ù–∞—Ö–æ–¥–∏–º –∑–∞—è–≤–∫—É
    payment = None
    for p in pending_payments:
        if p['id'] == payment_id and p['status'] == 'pending':
            payment = p
            break
    
    if not payment:
        await callback.answer("–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞", show_alert=True)
        return
    
    user_id = payment['user_id']
    
    # –ü–æ–º–µ—á–∞–µ–º –∑–∞—è–≤–∫—É –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—É—é
    payment['status'] = 'rejected'
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    new_text = (
        f"‚ùå –û–¢–ö–õ–û–ù–ï–ù–û\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {payment['user_full_name']}\n"
        f"üìõ @{payment['username'] or '–ù–µ—Ç username'}\n"
        f"üÜî ID: {payment['user_id']}\n"
        f"üí∞ –°—É–º–º–∞: {payment['amount']} —Ä—É–±.\n"
        f"‚è∞ –í—Ä–µ–º—è: {payment['timestamp']}\n"
        f"üïê –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    )
    
    await callback.message.edit_caption(
        caption=new_text,
        reply_markup=None  # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await bot.send_message(
            user_id,
            f"‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ {payment['amount']} —Ä—É–±. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.\n\n"
            f"–ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ —ç—Ç–æ –æ—à–∏–±–∫–æ–π, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        )
    except:
        pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
    
    await callback.answer("–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞")

# –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã
@dp.message(F.text == "üìã –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã")
async def show_pending_orders(message: types.Message):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
        
    pending_orders = [o for o in orders_db if o.get('status') == 'pending']
    
    if not pending_orders:
        await message.answer(
            "–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.",
            reply_markup=get_admin_keyboard()
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Å –∫–Ω–æ–ø–∫–∞–º–∏
    for order in pending_orders:
        user_id = order['user_id']
        user_data = users_db.get(user_id, {})
        username = user_data.get('username', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        
        text = (
            f"üìã –ó–∞–∫–∞–∑ #{order['order_id']}\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {order.get('user_full_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
            f"üìõ @{username or '–ù–µ—Ç username'}\n"
            f"üÜî ID: {user_id}\n"
            f"üîó –°—Å—ã–ª–∫–∞: {order['link']}\n"
            f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤: {order['reviews_count']}\n"
            f"üìù –¢–µ–∫—Å—Ç: {order['review_text'][:100]}...\n"
            f"üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã: {order['contacts']}\n"
            f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {order['cost']} —Ä—É–±.\n"
            f"‚è∞ –í—Ä–µ–º—è: {order['timestamp']}"
        )
        
        # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(text="‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω", callback_data=f"complete_order_{order['order_id']}"),
                InlineKeyboardButton(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_order_{order['order_id']}")
            ]
        ])
        
        await message.answer(text, reply_markup=keyboard)
    
    await message.answer(
        f"–í—Å–µ–≥–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤: {len(pending_orders)}",
        reply_markup=get_admin_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–ø–æ–ª–Ω–µ–Ω" –¥–ª—è –∑–∞–∫–∞–∑–∞
@dp.callback_query(F.data.startswith("complete_order_"))
async def complete_order(callback: types.CallbackQuery, state: FSMContext):
    order_id = int(callback.data.split("_")[2])
    
    # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑
    order = None
    for o in orders_db:
        if o['order_id'] == order_id and o.get('status') == 'pending':
            order = o
            break
    
    if not order:
        await callback.answer("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω", show_alert=True)
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(order_id=order_id)
    
    # –ü—Ä–æ—Å–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–∑—ã–≤–∞
    await callback.message.answer(
        f"üì∏ –î–ª—è –∑–∞–∫–∞–∑–∞ #{order_id} –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞:",
        reply_markup=get_cancel_keyboard()
    )
    
    await state.set_state(AdminStates.waiting_for_screenshot)
    await callback.answer()

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –æ—Ç–∑—ã–≤–∞
@dp.message(AdminStates.waiting_for_screenshot)
async def process_review_screenshot(message: types.Message, state: FSMContext):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer(
            "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞",
            reply_markup=get_admin_keyboard()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–æ—Ç–æ
    if not message.photo:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–∑—ã–≤–∞:", reply_markup=get_cancel_keyboard())
        return
    
    data = await state.get_data()
    order_id = data['order_id']
    
    # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑
    order = None
    for o in orders_db:
        if o['order_id'] == order_id:
            order = o
            break
    
    if not order:
        await message.answer("–û—à–∏–±–∫–∞: –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", reply_markup=get_admin_keyboard())
        await state.clear()
        return
    
    user_id = order['user_id']
    
    # –ü–æ–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π
    order['status'] = 'completed'
    order['completed_at'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        await bot.send_photo(
            user_id,
            message.photo[-1].file_id,
            caption=f"‚úÖ –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –≤—ã–ø–æ–ª–Ω–µ–Ω!\n\n"
                   f"üîó –°—Å—ã–ª–∫–∞: {order['link']}\n"
                   f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤: {order['reviews_count']}\n"
                   f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {order['cost']} —Ä—É–±.\n\n"
                   f"–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! üéâ"
        )
    except:
        pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
    
    await message.answer(
        f"‚úÖ –ó–∞–∫–∞–∑ #{order_id} –≤—ã–ø–æ–ª–Ω–µ–Ω!\n"
        f"–°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.",
        reply_markup=get_admin_keyboard()
    )
    
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–∫–ª–æ–Ω–∏—Ç—å" –¥–ª—è –∑–∞–∫–∞–∑–∞
@dp.callback_query(F.data.startswith("reject_order_"))
async def reject_order_handler(callback: types.CallbackQuery, state: FSMContext):
    order_id = int(callback.data.split("_")[2])
    
    # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑
    order = None
    for o in orders_db:
        if o['order_id'] == order_id and o.get('status') == 'pending':
            order = o
            break
    
    if not order:
        await callback.answer("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω", show_alert=True)
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(order_id=order_id)
    
    # –ü—Ä–æ—Å–∏–º –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞
    await callback.message.answer(
        f"üìù –î–ª—è –∑–∞–∫–∞–∑–∞ #{order_id} —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞:",
        reply_markup=get_cancel_keyboard()
    )
    
    await state.set_state(AdminStates.waiting_for_rejection_reason)
    await callback.answer()

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞
@dp.message(AdminStates.waiting_for_rejection_reason)
async def process_rejection_reason(message: types.Message, state: FSMContext):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await state.clear()
        await message.answer(
            "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞",
            reply_markup=get_admin_keyboard()
        )
        return
    
    data = await state.get_data()
    order_id = data['order_id']
    reason = message.text
    
    # –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑
    order = None
    for o in orders_db:
        if o['order_id'] == order_id:
            order = o
            break
    
    if not order:
        await message.answer("–û—à–∏–±–∫–∞: –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", reply_markup=get_admin_keyboard())
        await state.clear()
        return
    
    user_id = order['user_id']
    cost = order['cost']
    
    # –ü–æ–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑ –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π
    order['status'] = 'rejected'
    order['rejected_at'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    order['rejection_reason'] = reason
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å
    init_user(user_id)
    users_db[user_id]['balance'] += cost
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        await bot.send_message(
            user_id,
            f"‚ùå –í–∞—à –∑–∞–∫–∞–∑ #{order_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω.\n\n"
            f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n"
            f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ ({cost} —Ä—É–±.) –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å.\n"
            f"üíº –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {users_db[user_id]['balance']} —Ä—É–±.\n\n"
            f"–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        )
    except:
        pass  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
    
    await message.answer(
        f"‚ùå –ó–∞–∫–∞–∑ #{order_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω.\n"
        f"üí∞ –î–µ–Ω—å–≥–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
        reply_markup=get_admin_keyboard()
    )
    
    await state.clear()

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
@dp.message(F.text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def show_stats(message: types.Message):
    if message.from_user.id != ADMIN_CHAT_ID:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
        
    total_users = len(users_db)
    total_orders = len(orders_db)
    total_balance = sum(user['balance'] for user in users_db.values())
    active_users = len([user for user in users_db.values() if user['orders_count'] > 0])
    pending_count = len([p for p in pending_payments if p['status'] == 'pending'])
    pending_orders_count = len([o for o in orders_db if o.get('status') == 'pending'])
    completed_orders_count = len([o for o in orders_db if o.get('status') == 'completed'])
    
    await message.answer(
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n"
        f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"üî• –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {active_users}\n"
        f"üì¶ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {total_orders}\n"
        f"‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤: {completed_orders_count}\n"
        f"‚è≥ –û–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤: {pending_orders_count}\n"
        f"üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: {total_balance} —Ä—É–±.\n"
        f"üí≥ –û–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π: {pending_count}"
    )

# –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
@dp.message(F.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
async def back_to_main(message: types.Message):
    user_id = message.from_user.id
    await message.answer(
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        reply_markup=get_main_keyboard(user_id)
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã"
@dp.message(F.text == "üìù –ó–∞–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤—ã")
async def start_order(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    init_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    if users_db[user_id]['balance'] <= 0:
        await message.answer(
            "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.\n"
            "–î–ª—è –∑–∞–∫–∞–∑–∞ –æ—Ç–∑—ã–≤–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å.\n\n"
            "–ù–∞–∂–º–∏—Ç–µ 'üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å' –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.",
            reply_markup=get_main_keyboard(user_id)
        )
        return
        
    await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ –≤ 2–ì–ò–°:",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(OrderStates.waiting_for_link)

# –û—Ç–º–µ–Ω–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞ (–æ–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
@dp.message(F.text == "‚ùå –û—Ç–º–µ–Ω–∞")
async def cancel_order(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    if current_state is None:
        return
        
    await state.clear()
    user_id = message.from_user.id
    await message.answer(
        "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞",
        reply_markup=get_main_keyboard(user_id)
    )

# –ü—Ä–∏–µ–º —Å—Å—ã–ª–∫–∏
@dp.message(OrderStates.waiting_for_link)
async def process_link(message: types.Message, state: FSMContext):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_order(message, state)
        return
        
    if not ("2gis.ru" in message.text or "2gis.kz" in message.text):
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ 2–ì–ò–°:", reply_markup=get_cancel_keyboard())
        return

    await state.update_data(link=message.text)
    await message.answer("–°–∫–æ–ª—å–∫–æ –æ—Ç–∑—ã–≤–æ–≤ –≤–∞–º –Ω—É–∂–Ω–æ?", reply_markup=get_cancel_keyboard())
    await state.set_state(OrderStates.waiting_for_reviews_count)

# –ü—Ä–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤
@dp.message(OrderStates.waiting_for_reviews_count)
async def process_reviews_count(message: types.Message, state: FSMContext):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_order(message, state)
        return
        
    if not message.text.isdigit():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ:", reply_markup=get_cancel_keyboard())
        return

    reviews_count = int(message.text)
    if reviews_count > 50:
        await message.answer("–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –ú–∞–∫—Å–∏–º—É–º 50 –æ—Ç–∑—ã–≤–æ–≤ –∑–∞ —Ä–∞–∑:", reply_markup=get_cancel_keyboard())
        return

    await state.update_data(reviews_count=reviews_count)
    
    await message.answer(
        "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ (–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):\n\n"
        "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å', –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã –º—ã —Å–æ—Å—Ç–∞–≤–∏–ª–∏ —Ç–µ–∫—Å—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ",
        reply_markup=get_skip_text_keyboard()
    )
    await state.set_state(OrderStates.waiting_for_review_text)

# –ü—Ä–∏–µ–º —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞
@dp.message(OrderStates.waiting_for_review_text)
async def process_review_text(message: types.Message, state: FSMContext):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_order(message, state)
        return
        
    if message.text == "‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å":
        review_text = "–¢–µ–∫—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω (–±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
    else:
        if len(message.text) < 10:
            await message.answer("–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤:", reply_markup=get_skip_text_keyboard())
            return
        if len(message.text) > 1000:
            await message.answer("–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤:", reply_markup=get_skip_text_keyboard())
            return
        review_text = message.text

    await state.update_data(review_text=review_text)
    await message.answer(
        "–û—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏ (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram):",
        reply_markup=get_cancel_keyboard()
    )
    await state.set_state(OrderStates.waiting_for_contacts)

# –ü—Ä–∏–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
@dp.message(OrderStates.waiting_for_contacts)
async def process_contacts(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await cancel_order(message, state)
        return
        
    await state.update_data(contacts=message.text)
    user_data = await state.get_data()

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞)
    cost = user_data['reviews_count'] * 10  # 10 —Ä—É–± –∑–∞ –æ—Ç–∑—ã–≤
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    if users_db[user_id]['balance'] < cost:
        await message.answer(
            f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞: {cost} —Ä—É–±.\n"
            f"üíº –í–∞—à –±–∞–ª–∞–Ω—Å: {users_db[user_id]['balance']} —Ä—É–±.\n\n"
            "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            reply_markup=get_main_keyboard(user_id)
        )
        await state.clear()
        return

    # –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
    users_db[user_id]['balance'] -= cost
    users_db[user_id]['orders_count'] += 1

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑
    order_id = generate_order_id()
    order_data = {
        'order_id': order_id,
        'user_id': user_id,
        'user_full_name': message.from_user.full_name,
        'link': user_data['link'],
        'reviews_count': user_data['reviews_count'],
        'review_text': user_data.get('review_text', '–ù–µ —É–∫–∞–∑–∞–Ω'),
        'contacts': user_data['contacts'],
        'cost': cost,
        'status': 'pending',
        'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    orders_db.append(order_data)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    order_text = (
        "üì® –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –æ—Ç–∑—ã–≤–æ–≤!\n\n"
        f"üîó –°—Å—ã–ª–∫–∞: {user_data['link']}\n"
        f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤: {user_data['reviews_count']}\n"
        f"üìù –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞: {user_data.get('review_text', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
        f"üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã: {user_data['contacts']}\n"
        f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {cost} —Ä—É–±.\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{message.from_user.username or '–ù–µ—Ç username'}\n"
        f"üÜî ID: {message.from_user.id}\n"
        f"üíº –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è: {users_db[user_id]['balance']} —Ä—É–±."
    )

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    await bot.send_message(ADMIN_CHAT_ID, order_text)
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await message.answer(
        "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!\n\n"
        f"‚Ä¢ –°—Å—ã–ª–∫–∞: {user_data['link']}\n"
        f"‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤: {user_data['reviews_count']}\n"
        f"‚Ä¢ –¢–µ–∫—Å—Ç: {user_data.get('review_text', '–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏')}\n"
        f"‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: {cost} —Ä—É–±.\n"
        f"‚Ä¢ –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è: {users_db[user_id]['balance']} —Ä—É–±.\n\n"
        "–° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.",
        reply_markup=get_main_keyboard(user_id)
    )
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
@dp.message(F.text == "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
async def show_info(message: types.Message):
    await message.answer(
        "üíº –£—Å–ª—É–≥–∏ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é –≤ 2–ì–ò–°\n\n"
        "‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã\n"
        "‚úÖ –†–∞–±–æ—Ç–∞–µ–º –±—ã—Å—Ç—Ä–æ –∏ –∞–Ω–æ–Ω–∏–º–Ω–æ\n"
        "‚úÖ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∫–∞–∂–¥–æ–º—É –∫–ª–∏–µ–Ω—Ç—É\n"
        "‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞\n\n"
        "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 10 —Ä—É–±. –∑–∞ 1 –æ—Ç–∑—ã–≤\n\n"
    )

@dp.message(F.text == "üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
async def show_support(message: types.Message):
    await message.answer(
        "–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É:\n"
        "üìû @grackswag\n"
        "–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 10:00 - 20:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ"
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message()
async def handle_other_messages(message: types.Message):
    user_id = message.from_user.id
    await message.answer(
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:",
        reply_markup=get_main_keyboard(user_id)
    )

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    logging.basicConfig(level=logging.INFO)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
